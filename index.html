<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTV 搜尋</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #output { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>KTV 搜尋</h1>
    <input type="text" id="songInput" placeholder="請輸入要搜尋的歌名">
    <button onclick="searchSong()">搜尋</button>
    <div id="output"></div>

    <script>
        async function main() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            await pyodide.runPythonAsync(`
                def parse_performances():
                    performances = {}
                    current_session = ""
                    current_url = ""
                    
                    # 讀取檔案內容
                    try:
                        with open('song_list.txt', 'r', encoding='utf-8') as file:
                            lines = file.readlines()
                    except FileNotFoundError:
                        print("找不到 song_list.txt 檔案")
                        return {}
                    
                    for line in lines:
                        line = line.strip()
                        if "https://youtu.be/" in line:
                            if "補錄" in line:
                                current_session = line.split()[0] + " 補錄"
                            else:
                                current_session = line.split()[0]
                            current_url = line.split()[-1]
                        elif line and ":" in line and not line.startswith("#"):
                            try:
                                timestamp, song = line.split(" ", 1)
                                if song not in performances:
                                    performances[song] = []
                                performances[song].append({
                                    "session": current_session,
                                    "url": current_url,
                                    "timestamp": timestamp
                                })
                            except:
                                continue
                    
                    return performances

                def search_song(song_name):
                    performances = parse_performances()
                    
                    if song_name in performances:
                        print(f"\\n找到 '{song_name}' 的演唱記錄：")
                        for perf in performances[song_name]:
                            print(f"{perf['session']} - {perf['url']}?t={time_to_seconds(perf['timestamp'])}")
                    else:
                        print(f"\\n找不到 '{song_name}' 的演唱記錄")

                def time_to_seconds(time_str):
                    if ':' not in time_str:
                        return 0
                    
                    parts = time_str.split(':')
                    if len(parts) == 2:
                        return int(parts[0]) * 60 + int(parts[1])
                    elif len(parts) == 3:
                        return int(parts[0]) * 3600 + int(parts[1]) * 60 + int(parts[2])
                    return 0
            `);
            window.pyodide = pyodide;
        }

        function searchSong() {
            const songName = document.getElementById('songInput').value;
            const output = document.getElementById('output');
            output.innerHTML = '';
            window.pyodide.runPythonAsync(`
                search_song("${songName}")
            `).then(result => {
                output.innerHTML = result;
            });
        }

        main();
    </script>
</body>
</html> 